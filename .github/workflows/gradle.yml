name: ðŸ”§ MoBends API Auto-Fix for MC 1.20.1

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run - show changes without committing'
        required: false
        default: 'false'
        type: boolean
  push:
    branches: [ main, master, develop ]
    paths:
      - '**.java'

jobs:
  fix-api-compatibility:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: ðŸ”§ Create Comprehensive API Fixer
      run: |
        cat > mobends_api_fixer.py << 'EOF'
        #!/usr/bin/env python3
        """
        MoBends Comprehensive API Fixer for Minecraft 1.20.1
        Fixes all deprecated and removed API calls based on the build errors
        """
        
        import os
        import re
        import glob
        import json
        from pathlib import Path
        from typing import Dict, List, Set
        
        class MoBendsAPIFixer:
            def __init__(self):
                self.modified_files = []
                self.errors = []
                
                # å®Œæ•´çš„APIæ˜ å°„è§„åˆ™ï¼ŒåŸºäºŽå®žé™…ç¼–è¯‘é”™è¯¯
                self.fixes = {
                    # 1. ResourceLocation æž„é€ å‡½æ•°ä¿®å¤
                    'resource_location_namespace': {
                        'pattern': r'new ResourceLocation\(([^,)]+),\s*([^)]+)\)',
                        'replacement': r'ResourceLocation.fromNamespaceAndPath(\1, \2)',
                        'description': 'Fix ResourceLocation(namespace, path) constructor'
                    },
                    'resource_location_single': {
                        'pattern': r'new ResourceLocation\(([^,)]+)\)',
                        'replacement': r'ResourceLocation.parse(\1)',
                        'description': 'Fix ResourceLocation(path) constructor'
                    },
                    
                    # 2. æ¸²æŸ“ç³»ç»Ÿä¿®å¤
                    'glstatemanager_to_rendersystem': {
                        'pattern': r'GlStateManager\.',
                        'replacement': 'RenderSystem.',
                        'description': 'Replace GlStateManager with RenderSystem'
                    },
                    'bufferbuilder_to_vertexconsumer': {
                        'pattern': r'\bBufferBuilder\b',
                        'replacement': 'VertexConsumer',
                        'description': 'Replace BufferBuilder with VertexConsumer'
                    },
                    'tessellator_getbuilder': {
                        'pattern': r'Tessellator\.getInstance\(\)\.getBuilder\(\)',
                        'replacement': 'vertexConsumer /* TODO: Get VertexConsumer from MultiBufferSource */',
                        'description': 'Replace Tessellator.getInstance().getBuilder()'
                    },
                    
                    # 3. ç‰¹å®šçš„æ¸²æŸ“è°ƒç”¨ä¿®å¤
                    'gl_push_matrix': {
                        'pattern': r'GlStateManager\.pushMatrix\(\)',
                        'replacement': 'poseStack.pushPose()',
                        'description': 'Replace pushMatrix with pushPose'
                    },
                    'gl_pop_matrix': {
                        'pattern': r'GlStateManager\.popMatrix\(\)',
                        'replacement': 'poseStack.popPose()',
                        'description': 'Replace popMatrix with popPose'
                    },
                    'gl_translate': {
                        'pattern': r'GlStateManager\.translate\(([^)]+)\)',
                        'replacement': r'poseStack.translate(\1)',
                        'description': 'Replace GlStateManager.translate'
                    },
                    'gl_rotate': {
                        'pattern': r'GlStateManager\.rotate\(([^)]+)\)',
                        'replacement': r'poseStack.mulPose(Axis.XP.rotationDegrees(\1)) /* TODO: Convert to proper quaternion rotation */',
                        'description': 'Replace GlStateManager.rotate'
                    },
                    'gl_scale': {
                        'pattern': r'GlStateManager\.scale\(([^)]+)\)',
                        'replacement': r'poseStack.scale(\1)',
                        'description': 'Replace GlStateManager.scale'
                    },
                    'gl_color': {
                        'pattern': r'GlStateManager\.color\(([^)]+)\)',
                        'replacement': r'RenderSystem.setShaderColor(\1)',
                        'description': 'Replace GlStateManager.color'
                    },
                    'gl_enable_blend': {
                        'pattern': r'GlStateManager\.enableBlend\(\)',
                        'replacement': 'RenderSystem.enableBlend()',
                        'description': 'Replace GlStateManager.enableBlend'
                    },
                    'gl_disable_blend': {
                        'pattern': r'GlStateManager\.disableBlend\(\)',
                        'replacement': 'RenderSystem.disableBlend()',
                        'description': 'Replace GlStateManager.disableBlend'
                    },
                    
                    # 4. ModLoadingContext ä¿®å¤ï¼ˆæ·»åŠ å…¼å®¹æ€§æ³¨é‡Šï¼‰
                    'mod_loading_context': {
                        'pattern': r'ModLoadingContext\.get\(\)',
                        'replacement': 'ModLoadingContext.get() /* TODO: Verify this is still available in your Forge version */',
                        'description': 'Add compatibility note for ModLoadingContext.get()'
                    },
                    'fml_java_mod_loading_context': {
                        'pattern': r'FMLJavaModLoadingContext\.get\(\)',
                        'replacement': 'FMLJavaModLoadingContext.get() /* TODO: Verify this is still available */',
                        'description': 'Add compatibility note for FMLJavaModLoadingContext.get()'
                    }
                }
                
                # å¯¼å…¥æ›¿æ¢è§„åˆ™
                self.import_replacements = {
                    # ç§»é™¤çš„å¯¼å…¥
                    'remove': [
                        'import net.minecraft.client.renderer.BufferBuilder;',
                        'import net.minecraft.client.renderer.GLAllocation;',
                        'import net.minecraft.client.renderer.GlStateManager;',
                        'import net.minecraft.client.model.TextureOffset;',
                        'import net.minecraft.client.renderer.Tessellator;',
                        'import net.minecraft.client.renderer.vertex.DefaultVertexFormats;',
                        'import org.lwjgl.opengl.GL11;'
                    ],
                    # æ·»åŠ çš„å¯¼å…¥
                    'add': [
                        'import com.mojang.blaze3d.vertex.VertexConsumer;',
                        'import com.mojang.blaze3d.vertex.PoseStack;',
                        'import com.mojang.blaze3d.systems.RenderSystem;',
                        'import net.minecraft.client.renderer.MultiBufferSource;',
                        'import net.minecraft.client.renderer.RenderType;',
                        'import org.joml.Matrix4f;',
                        'import org.joml.Matrix3f;',
                        'import com.mojang.math.Axis;',
                        'import net.minecraft.client.model.geom.ModelPart;',
                        'import net.minecraft.client.model.geom.PartPose;'
                    ]
                }
        
            def should_add_imports(self, content: str) -> bool:
                """æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ æ–°çš„å¯¼å…¥"""
                indicators = [
                    'VertexConsumer', 'PoseStack', 'RenderSystem', 'MultiBufferSource',
                    'Matrix4f', 'Matrix3f', 'Axis', 'ModelPart', 'PartPose'
                ]
                return any(indicator in content for indicator in indicators)
        
            def fix_imports(self, content: str) -> str:
                """ä¿®å¤å¯¼å…¥è¯­å¥"""
                # ç§»é™¤åºŸå¼ƒçš„å¯¼å…¥
                for imp in self.import_replacements['remove']:
                    if imp in content:
                        content = content.replace(imp, f'// REMOVED DEPRECATED: {imp}')
                        print(f"    â€¢ Removed deprecated import: {imp.split()[-1].rstrip(';')}")
                
                # å¦‚æžœéœ€è¦ï¼Œæ·»åŠ æ–°çš„å¯¼å…¥
                if self.should_add_imports(content):
                    # æ‰¾åˆ°æœ€åŽä¸€ä¸ªimportè¯­å¥çš„ä½ç½®
                    import_matches = list(re.finditer(r'import\s+[^;]+;', content))
                    if import_matches:
                        last_import_end = import_matches[-1].end()
                        
                        # æ£€æŸ¥å“ªäº›å¯¼å…¥è¿˜ä¸å­˜åœ¨
                        new_imports = []
                        for imp in self.import_replacements['add']:
                            if imp not in content and not imp.replace('import ', '// REMOVED DEPRECATED: import ') in content:
                                new_imports.append(imp)
                        
                        if new_imports:
                            import_block = '\n' + '\n'.join(new_imports)
                            content = content[:last_import_end] + import_block + content[last_import_end:]
                            print(f"    â€¢ Added {len(new_imports)} new imports")
                
                return content
        
            def apply_api_fixes(self, content: str) -> tuple[str, List[str]]:
                """åº”ç”¨æ‰€æœ‰APIä¿®å¤"""
                applied_fixes = []
                
                for fix_name, fix_data in self.fixes.items():
                    pattern = fix_data['pattern']
                    replacement = fix_data['replacement']
                    
                    if re.search(pattern, content):
                        content = re.sub(pattern, replacement, content)
                        applied_fixes.append(fix_data['description'])
                
                return content, applied_fixes
        
            def fix_file(self, file_path: str) -> bool:
                """ä¿®å¤å•ä¸ªæ–‡ä»¶"""
                try:
                    with open(file_path, 'r', encoding='utf-8') as f:
                        original_content = f.read()
                    
                    content = original_content
                    
                    # åº”ç”¨APIä¿®å¤
                    content, applied_fixes = self.apply_api_fixes(content)
                    
                    # ä¿®å¤å¯¼å…¥
                    content = self.fix_imports(content)
                    
                    # å¦‚æžœå†…å®¹æœ‰å˜åŒ–ï¼Œå†™å›žæ–‡ä»¶
                    if content != original_content:
                        with open(file_path, 'w', encoding='utf-8') as f:
                            f.write(content)
                        
                        self.modified_files.append(file_path)
                        print(f"âœ“ {file_path}")
                        for fix in applied_fixes:
                            print(f"    â€¢ {fix}")
                        return True
                        
                except Exception as e:
                    error_msg = f"Error processing {file_path}: {e}"
                    self.errors.append(error_msg)
                    print(f"âœ— {error_msg}")
                
                return False
        
            def process_all_files(self):
                """å¤„ç†æ‰€æœ‰Javaæ–‡ä»¶"""
                print("ðŸ”§ Starting MoBends API compatibility fixes for MC 1.20.1...")
                print("ðŸ“‚ Scanning for Java files...")
                
                java_files = glob.glob('**/*.java', recursive=True)
                print(f"ðŸ“‹ Found {len(java_files)} Java files to process")
                
                print("\nðŸ”¨ Applying fixes...")
                for file_path in java_files:
                    self.fix_file(file_path)
                
                # ç”ŸæˆæŠ¥å‘Š
                print(f"\nðŸ“Š Fix Summary:")
                print(f"   Files processed: {len(java_files)}")
                print(f"   Files modified: {len(self.modified_files)}")
                print(f"   Errors: {len(self.errors)}")
                
                if self.errors:
                    print(f"\nâŒ Errors encountered:")
                    for error in self.errors:
                        print(f"   â€¢ {error}")
                
                # ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
                self.generate_report()
        
            def generate_report(self):
                """ç”Ÿæˆè¯¦ç»†çš„ä¿®å¤æŠ¥å‘Š"""
                report = {
                    'timestamp': str(datetime.now()),
                    'total_files': len(glob.glob('**/*.java', recursive=True)),
                    'modified_files': self.modified_files,
                    'errors': self.errors,
                    'fixes_applied': list(self.fixes.keys())
                }
                
                with open('mobends_api_fix_report.json', 'w') as f:
                    json.dump(report, f, indent=2)
                
                # æ–‡æœ¬æŠ¥å‘Š
                with open('mobends_api_fix_summary.txt', 'w') as f:
                    f.write("MoBends API Compatibility Fix Report\n")
                    f.write("="*40 + "\n\n")
                    f.write(f"Files processed: {report['total_files']}\n")
                    f.write(f"Files modified: {len(self.modified_files)}\n")
                    f.write(f"Success rate: {len(self.modified_files)/report['total_files']*100:.1f}%\n\n")
                    
                    f.write("Modified files:\n")
                    for file in self.modified_files:
                        f.write(f"  âœ“ {file}\n")
                    
                    f.write(f"\nFixes applied:\n")
                    for fix_name, fix_data in self.fixes.items():
                        f.write(f"  â€¢ {fix_data['description']}\n")
                    
                    if self.errors:
                        f.write(f"\nErrors:\n")
                        for error in self.errors:
                            f.write(f"  âœ— {error}\n")
                    
                    f.write(f"\nNext steps:\n")
                    f.write(f"  1. Review vertex consumer and pose stack usage\n")
                    f.write(f"  2. Test rendering functionality\n")
                    f.write(f"  3. Verify mod loading context calls\n")
                    f.write(f"  4. Run gradle build to check for remaining errors\n")
        
        # è¿è¡Œä¿®å¤å™¨
        if __name__ == "__main__":
            import datetime
            fixer = MoBendsAPIFixer()
            fixer.process_all_files()
        EOF
        
        python3 mobends_api_fixer.py

    - name: ðŸ“‹ Check for Changes
      id: check_changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ“ Changes detected - will commit and push"
          git status --short
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "âœ… No changes needed"
        fi

    - name: ðŸ” Show Diff (if dry run)
      if: github.event.inputs.dry_run == 'true' && steps.check_changes.outputs.changes == 'true'
      run: |
        echo "ðŸ” Changes that would be made:"
        git diff --name-only
        echo ""
        echo "ðŸ“„ Sample of changes:"
        git diff | head -100

    - name: ðŸ“ Commit and Push Changes
      if: steps.check_changes.outputs.changes == 'true' && github.event.inputs.dry_run != 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # é…ç½®Git
        git config --local user.email "z3407323905@outlook.com"
        git config --local user.name "OutlinedArc217"
        
        # æ·»åŠ æ‰€æœ‰ä¿®æ”¹çš„æ–‡ä»¶
        git add -A
        
        # åˆ›å»ºæäº¤æ¶ˆæ¯
        cat > commit_message.txt << 'EOF'
        ðŸ”§ Auto-fix MoBends API compatibility for MC 1.20.1
        
        This automated fix addresses all major API compatibility issues:
        
        âœ… Fixed ResourceLocation deprecated constructors
        âœ… Replaced GlStateManager with RenderSystem
        âœ… Updated BufferBuilder to VertexConsumer
        âœ… Removed deprecated imports (GLAllocation, TextureOffset, etc.)
        âœ… Added modern rendering imports
        âœ… Updated matrix operations for new API
        âœ… Added compatibility notes for verification
        
        Files modified: See mobends_api_fix_summary.txt
        
        âš ï¸  Manual verification needed:
        - Check VertexConsumer usage in rendering code
        - Verify ModLoadingContext calls work with Forge version
        - Test quaternion rotations replace old rotate calls
        - Review pose stack transformations
        
        Auto-generated by GitHub Actions ðŸ¤–
        EOF
        
        # æäº¤æ›´æ”¹
        git commit -F commit_message.txt
        
        # æŽ¨é€åˆ°è¿œç¨‹ä»“åº“
        git push origin 1.X/forge-1.12
        
        echo "âœ… Changes committed and pushed successfully!"

    - name: ðŸ“¤ Upload Fix Reports
      if: steps.check_changes.outputs.changes == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: mobends-api-fix-reports
        path: |
          mobends_api_fix_summary.txt
          mobends_api_fix_report.json

    - name: ðŸ§ª Test Build After Fixes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        echo "ðŸ”¨ Testing build after API fixes..."
        set +e  # Don't fail the action if build fails
        ./gradlew build --no-daemon --stacktrace
        BUILD_EXIT_CODE=$?
        
        if [ $BUILD_EXIT_CODE -eq 0 ]; then
          echo "âœ… Build successful after fixes!"
        else
          echo "âš ï¸  Build still has issues - manual review needed"
          echo "This is expected as some fixes may require additional manual adjustments"
        fi
